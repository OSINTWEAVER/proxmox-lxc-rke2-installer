# LXC-optimized containerd configuration
# This template modifies RKE2's embedded containerd to use cgroupfs instead of systemd cgroups
# and disables AppArmor to resolve compatibility issues in LXC containers
# NVIDIA runtime is configured directly since GPU Operator has limitations in LXC environments

version = 2

[plugins]
  [plugins."io.containerd.grpc.v1.cri"]
    # Disable AppArmor in LXC containers to prevent policy conflicts
    disable_apparmor = true
    
    [plugins."io.containerd.grpc.v1.cri".containerd]
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          runtime_type = "io.containerd.runc.v2"
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
            # Disable systemd cgroup management to fix LXC compatibility
            SystemdCgroup = false
            # Use cgroupfs driver instead
            BinaryName = "runc"
            # Disable AppArmor for containers
            NoPivotRoot = false
            NoNewKeyring = false
            ShimCgroup = ""
        
        # NVIDIA Container Runtime for GPU workloads in LXC
        # This is configured directly since GPU Operator has limitations in LXC environments
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.nvidia]
          runtime_type = "io.containerd.runc.v2"
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.nvidia.options]
            # Use nvidia-container-runtime for GPU containers
            BinaryName = "nvidia-container-runtime"
            # Disable systemd cgroup management for LXC compatibility
            SystemdCgroup = false
            # Disable AppArmor for GPU containers
            NoPivotRoot = false
            NoNewKeyring = false
            ShimCgroup = ""
    
    [plugins."io.containerd.grpc.v1.cri".cni]
      bin_dir = "/opt/cni/bin"
      conf_dir = "/etc/cni/net.d"
    
    [plugins."io.containerd.grpc.v1.cri".registry]
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
          endpoint = ["https://registry-1.docker.io"]
